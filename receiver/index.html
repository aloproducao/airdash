<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AirDash</title>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';"/>
</head>
<body>
<h1 id="name">AirDash</h1>

<button id="select-location">Choose Folder</button>
<span id="location"></span>

<br><br>

<label>Connection ID <input id="connection-id" value="simonbengtsson-airdash"></label>

<script src="../node_modules/peerjs/dist/peerjs.js"></script>
<script>
  if (require('electron-is-dev')) {
    document.querySelector('#name').textContent = 'AirDash Local'
  }

  document.querySelector('#location').textContent = locationFolder();

  document.querySelector('#select-location').onclick = async () => {
    const { dialog } = require('electron').remote;
    const result = await dialog.showOpenDialog({
      properties: ['openDirectory']
    });
    const location = result.filePaths[0]
    if (location) {
      localStorage.setItem('location', location)
      document.querySelector('#location').textContent = location;
    }
  }

  const connectionId = document.querySelector('#connection-id').value
  const peer = new peerjs.Peer(connectionId)
  peer.on('connection', (conn) => {
    conn.on('data', (file) => {
      const path = require('path')
      const fs = require('fs')

      const filename = conn.metadata.filename || 'unknown'
      const filepath = path.join(locationFolder(), filename)
      fs.writeFileSync(filepath, new Buffer(file))
    })
  })

  function locationFolder() {
    const path = require('path')
    const os = require('os')
    const desktopPath = path.join(os.homedir(), 'Desktop')
    return localStorage.getItem('location') || desktopPath
  }
</script>
</body>
</html>