<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AirDash</title>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';"/>
</head>
<body>
<h1 id="name">AirDash</h1>

<button id="select-location">Choose Folder</button>
<span id="location"></span>

<br><br>

<label>Connection ID <input id="connection-id" value=""></label>
<button id="select-connection-id">Set</button>
<span id="connection-id-field"></span>

<script src="../node_modules/peerjs/dist/peerjs.js"></script>
<script>
  if (require('electron-is-dev')) {
    document.querySelector('#name').textContent = 'AirDash Dev'
  }

  document.querySelector('#location').textContent = locationFolder();
  document.querySelector('#connection-id-field').textContent = getConnectionId();

  document.querySelector('#select-connection-id').onclick = async () => {
    const idElem = document.querySelector('#connection-id')
    if (idElem.value.length > 2) {
      localStorage.setItem('connection-id', idElem.value)
      document.querySelector('#connection-id-field').textContent = idElem.value
    }
    idElem.value = ''
    reconnect()
  }

  document.querySelector('#select-location').onclick = async () => {
    const { dialog } = require('electron').remote;
    const result = await dialog.showOpenDialog({
      properties: ['openDirectory']
    });
    const location = result.filePaths[0]
    if (location) {
      localStorage.setItem('location', location)
      document.querySelector('#location').textContent = location;
    }
  }

  let previousPeer = null;
  reconnect()
  function reconnect() {
    if (previousPeer) previousPeer.destroy()
    const connectionId = `flownio-airdash-${getConnectionId()}`
    const peer = new peerjs.Peer(connectionId)
    console.log(`Listening on ${connectionId}...`)
    peer.on('connection', (conn) => {
      conn.on('data', (file) => {
        const path = require('path')
        const fs = require('fs')

        const filename = conn.metadata.filename || 'unknown'
        const filepath = path.join(locationFolder(), filename)
        fs.writeFileSync(filepath, new Buffer(file))
        conn.send('done')
        console.log('Received ' + filepath)
      })
    })
    previousPeer = peer
  }

  function locationFolder() {
    const path = require('path')
    const os = require('os')
    const desktopPath = path.join(os.homedir(), 'Desktop')
    return localStorage.getItem('location') || desktopPath
  }

  function getConnectionId() {
    return localStorage.getItem('connection-id') || 'simon'
  }
</script>
</body>
</html>