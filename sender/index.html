<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="manifest" href="./manifest.json" />
    <link rel="apple-touch-icon" href="./logo.png">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>AirDash</title>
  </head>
  <body>
    <h1>AirDash Local</h1>
    <p>One click file transfer from Android to Computer</p>

    <form action="./" method="POST" enctype="multipart/form-data">
      <input name="form" type="text" value="true">
      <label>File <input name="formfile" type="file"></label>
      <input type="submit">
    </form>

    <p>You can also share a file to this app from the Android share menu.</p>

    <p>The file will be sent to the the connected computer</p>

    <h3>Current Message</h3>
    <pre id="message">Loading...</pre>

    <script src="https://unpkg.com/localforage@1.7.3/dist/localforage.js"></script>
    <script src="https://unpkg.com/peerjs@1.0.0/dist/peerjs.min.js"></script>
    <script>
      ;(async function() {
        try {
          await navigator.serviceWorker.register('./sw.js')
        } catch(err) {
          console.log('sw failed', err)
        }

        const file = await localforage.getItem('file')
        const filename = await localforage.getItem('filename')

        if (file && filename) {
          const peer = new peerjs.Peer()
          const conn = peer.connect('flownio-airdash-simon', {metadata: { filename }})
          conn.on('open', function() {
            conn.send(file)
            document.querySelector('#message').textContent = filename
            console.log('File sent 2', filename, file)
          })
          conn.on('error', function(err) {
            console.log('err', err)
          })
        } else {
          console.log('File was not stored')
          await localforage.iterate(function(value, key) {
            console.log('STORED', key, value);
          })
        }
      })()
    </script>
  </body>
</html>
